
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Adding Target Drivers &#8212; Black Magic Debug  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-player_2.6.1.css" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/platformpicker.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/asciinema-player_2.6.1.js"></script>
    <script src="../_static/platformpicker.js"></script>
    <link rel="canonical" href="https://black-magic.org/hacking/target-drivers.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cortex M Targets" href="target-cortex-m.html" />
    <link rel="prev" title="Firmware Hacking" href="hacking.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="adding-target-drivers">
<h1>Adding Target Drivers<a class="headerlink" href="#adding-target-drivers" title="Permalink to this heading">¶</a></h1>
<p>This is a placeholder of cut-and-pasted text until I have a chance to write up some real documentation for the target API.</p>
<section id="external-target-api">
<h2>External target API<a class="headerlink" href="#external-target-api" title="Permalink to this heading">¶</a></h2>
<p>You can find the public API in <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/include/target.h"><code class="docutils literal notranslate"><span class="pre">target.h</span></code></a>, used by the GDB server. Nothing outside of this header should be accessed from outside of <code class="docutils literal notranslate"><span class="pre">src/target/*</span></code></p>
</section>
<section id="internal-target-api">
<h2>Internal target API<a class="headerlink" href="#internal-target-api" title="Permalink to this heading">¶</a></h2>
<p>Structure definitions and convenience functions for use in target implementations are defined in <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/target_internal.h">target/target_internal.h</a>. Specific target implementations fill in the function pointers in these structures for their device specific implementations</p>
</section>
<section id="raw-jtag-devices">
<h2>Raw JTAG Devices<a class="headerlink" href="#raw-jtag-devices" title="Permalink to this heading">¶</a></h2>
<p>Supported JTAG devices are defined in <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/jtag_scan.c#L35">target/jtag_scan.c</a></p>
<p>The <code class="docutils literal notranslate"><span class="pre">.handler</span></code> function is called when a device IDCODE matches <code class="docutils literal notranslate"><span class="pre">.idcode</span></code> with <code class="docutils literal notranslate"><span class="pre">.idmask</span></code> applied.
It is the responsibility of the handler function to instantiate a new target with <code class="docutils literal notranslate"><span class="pre">target_new</span></code> and fill in the access methods.</p>
<p>These functions provide access to the JTAG IR and DR registers:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">jtag_dev_write_ir</span><span class="p">(</span><span class="n">jtag_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ir</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">jtag_dev_shift_dr</span><span class="p">(</span><span class="n">jtag_dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">dout</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">din</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ticks</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="arm-implementations-adiv5">
<h2>ARM implementations (ADIv5)<a class="headerlink" href="#arm-implementations-adiv5" title="Permalink to this heading">¶</a></h2>
<p>This table is a list of known Coresight CIDR and PIDR values can be found in <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/adiv5.c#L156">target/adiv5.c</a></p>
<p>The ROM table is read from the ADIv5 Mem-AP, and the appropriate probe function is called in <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/adiv5.c#L323">target/adiv5.c</a>.</p>
<p>There is currently support for:</p>
<ul class="simple">
<li><p>ARMv6-M/ARMv7-M (<a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/cortexm.c">target/cortexm.c</a>)</p></li>
<li><p>ARMv7-A (<a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/cortexa.c">target/cortexa.c</a>)</p></li>
</ul>
<p>The <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/cortexm.c#L257">generic Cortex-M driver</a> calls probe functions for each supported vendor device.</p>
<p>These probe functions should probe the target device, add any memories they support with <code class="docutils literal notranslate"><span class="pre">target_add_ram</span></code> and <code class="docutils literal notranslate"><span class="pre">target_add_flash</span></code>, and return <code class="docutils literal notranslate"><span class="pre">true</span></code> for any device they support, or return <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
</section>
<section id="flash-programming">
<h2>Flash programming<a class="headerlink" href="#flash-programming" title="Permalink to this heading">¶</a></h2>
<p>The ADIv5 interface does not directly provide a way to write to flash. It’s implemented differently for different target devices.  This is done by filling in the function pointers in a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">target_flash</span></code> structure and calling <code class="docutils literal notranslate"><span class="pre">target_add_flash</span></code> on the target in the device specific probe function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">target_flash</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">target_addr</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Base address for this block of flash memory */</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w">          </span><span class="cm">/* Length of this block of flash memory */</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">blocksize</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Erase sector size for this block of flash memory */</span><span class="w"></span>
<span class="w">    </span><span class="n">flash_erase_func</span><span class="w"> </span><span class="n">erase</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Function pointer to flash erase function.</span>
<span class="cm">                               Called with address and length aligned on .blocksize */</span><span class="w"></span>
<span class="w">    </span><span class="n">flash_write_func</span><span class="w"> </span><span class="n">write</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Function pointer to flash write function.</span>
<span class="cm">                               Called with address and length aligned according to .align,</span>
<span class="cm">                               and padded with value in .erased. */</span><span class="w"></span>
<span class="w">    </span><span class="n">flash_done_func</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Called at the end of flash operations,generic Cortex-M driver</span>

<span class="cm">There are a few basic patterns for how this is done in practice:</span>

<span class="cm">- **Direct** - writes are passed directly to the target driver which programs the flash directly using MMIO. (eg. [kinetis.c](https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/kinetis.c))</span>
<span class="cm">- **Buffered** - the target layer will buffer write packets from GDB until and pass to the driver as writes of whole sectors. The driver will program the target flash directly using MMIO. This works well when whole sectors can be programmed with sequencial writes. (eg. [stm32l0.c](https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/stm32l0.c))</span>
<span class="cm">- **Stubbed** - writes are passed directly to the target driver which writes a program stub and the data payload to the target. The stub is then executed to program the device. This works well when flash can&#39;t be programmed with sequential writes. (eg. [stm32f1.c](https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/stm32f1.c))</span>
<span class="cm">- **LPC** - NXP devices include a built in ROM for programming flash. There is no published MMIO mechanism to program the flash on these devices. (eg. [lpc11xx.c](https://github.com/blackmagic-debug/blackmagic/blob/master/src/target/lpc11xx.c))</span>

<span class="cm">### Buffered Flash model</span>
<span class="cm">For devices than can only efficiently program flash sectors of a fixed size there is some additional support</span>
<span class="cm">in the `target_flash` structure.  To make use of this mechanism, the `.write` and `.done` pointers must be</span>
<span class="cm">assigned to `target_flash_write_buffered` and `target_flash_done_buffered` respectively.  The `.align` field should be left set to zero when using the buffered flash model.</span>
<span class="cm">```c</span>
<span class="cm">struct target_flash {</span>
<span class="cm">    ...</span>
<span class="cm">    /* For buffered flash */</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buf_size</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Size of buffer for buffered operations */</span><span class="w"></span>
<span class="w">    </span><span class="n">flash_write_func</span><span class="w"> </span><span class="n">write_buf</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Function pointer to buffered flash write function.</span>
<span class="cm">                                   Called with address aligned according to .buf_size,</span>
<span class="cm">                                   and padded with value in .erased.  The buffer</span>
<span class="cm">                                   will always be exactly .buf_size bytes */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="skeleton-driver">
<h2>Skeleton Driver<a class="headerlink" href="#skeleton-driver" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>static int skeleton_flash_erase(struct target_flash *f,
                                target_addr addr, size_t len) {…}
static int skeleton_flash_write(struct target_flash *f,
                                target_addr dest, const void *src, size_t len) {…}


static void skeleton_add_flash(target *t)
{
    struct target_flash *f = calloc(1, sizeof(*f));
    f-&gt;start = SKELETON_FLASH_BASE;
    f-&gt;length = SKELETON_FLASH_SIZE;
    f-&gt;blocksize = SKELETON_BLOCKSIZE;
    f-&gt;erase = skeleton_flash_erase;
    f-&gt;write = skeleton_flash_write;
    target_add_flash(t, f);
}


bool skeleton_probe(target *t)
{
    if (target_mem_read32(t, SKELETON_DEVID_ADDR) == SKELETON_DEVID) {
        skeleton_add_flash(t);
        return true;
    } else {
        return false;
    }
}
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Black Magic Debug</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Intro</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade.html">Firmware Upgrade</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Knowledgebase</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/terminology.html">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/gdb-commands.html">GDB Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/gdb-automation.html">GDB Flash Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/semihosting.html">Semihosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/traceswo.html">SWD - TRACESWO support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/swo.html">Serial Wire Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/platformio.html">PlatformIO</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Target Specific Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../target-usage/stm32.html">STM32 Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target-usage/sam3x-4x-x7x.html">SAM3x-4x-x7x</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hacking</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="contrib.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking.html">Firmware Hacking</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adding Target Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="target-cortex-m.html">Cortex M Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="target-cortex-a.html">Cortex A Targets</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="hacking.html" title="previous chapter">Firmware Hacking</a></li>
      <li>Next: <a href="target-cortex-m.html" title="next chapter">Cortex M Targets</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Piotr Esden-Tempski <piotr@esden.net>; 2022, Rachel Mant <git@dragonmux.network>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>